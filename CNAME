<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Manager Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase Compat Scripts (Essential for local file execution) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .seat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; }
        
        /* Glassmorphism & Aesthetics */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .sidebar-glass {
            background: linear-gradient(180deg, #ffffff 0%, #f1f5f9 100%);
        }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Seat Hover */
        .seat-card { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .seat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); z-index: 10; }
        
        .slot-btn { transition: background-color 0.2s; }
        .slot-btn:hover { filter: brightness(0.95); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        #error-display { display: none; }
        
        .ai-btn {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            background-size: 200% 200%;
            transition: all 0.3s ease;
        }
        .ai-btn:hover { filter: brightness(1.1); box-shadow: 0 0 15px rgba(168, 85, 247, 0.4); }
    </style>
</head>
<body>
    <div id="root">
        <div class="h-screen flex items-center justify-center flex-col bg-gray-50">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
            <div class="text-xl font-semibold text-gray-700">Loading Library Manager...</div>
        </div>
    </div>

    <div id="error-display" class="fixed top-0 left-0 w-full h-full bg-white z-50 p-10 flex flex-col items-center justify-center text-red-600">
        <h2 class="text-2xl font-bold mb-4">System Error</h2>
        <pre id="error-message" class="bg-red-50 p-4 rounded border border-red-200 font-mono text-sm"></pre>
        <button onclick="window.location.reload()" class="mt-6 px-6 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition">Reload Application</button>
    </div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('error-display').style.display = 'flex';
            document.getElementById('error-message').textContent = `${message}\nLine: ${lineno}`;
        };
    </script>

    <!-- REMOVED data-type="module" to fix "require is not defined" and CORS errors -->
    <script type="text/babel" data-presets="react">
        
        // --- CONFIGURATION ---
        const firebaseConfig = {
  apiKey: "AIzaSyDdNKKdN3kx4hDTCi4E0F3lvJ7NI_cnFg0",
  authDomain: "seattrack-pro.firebaseapp.com",
  projectId: "seattrack-pro",
  storageBucket: "seattrack-pro.firebasestorage.app",
  messagingSenderId: "53228301046",
  appId: "1:53228301046:web:db1ed816042a4526fa1ad7",
  measurementId: "G-8353MQHVRH"
};

        const apiKey = "AIzaSyCwt_K7LXccuVDhXrAw6Eot3SxM_Eyt1Yw";  

        // Initialize Firebase (Compat)
        let app, auth, db;
        try {
            if (!firebase.apps.length) {
                app = firebase.initializeApp(firebaseConfig);
            } else {
                app = firebase.app();
            }
            auth = firebase.auth();
            db = firebase.firestore();
        } catch (e) {
            console.error("Firebase Init Error:", e);
            throw new Error("Failed to initialize Firebase.");
        }

        // --- GEMINI API HELPER ---
        const callGemini = async (prompt) => {
            if (!apiKey) { alert("API Key Missing"); return null; }
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error("API Error");
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
            } catch (error) {
                console.error("AI Error:", error);
                return null;
            }
        };

        // --- COMPONENTS ---

        const AuthScreen = () => {
            const [isRegistering, setIsRegistering] = React.useState(false);
            const [email, setEmail] = React.useState("");
            const [password, setPassword] = React.useState("");
            const [libraryName, setLibraryName] = React.useState("");
            const [totalSeats, setTotalSeats] = React.useState(150);
            const [priceSingle, setPriceSingle] = React.useState(500);
            const [priceBoth, setPriceBoth] = React.useState(900);
            const [status, setStatus] = React.useState({ type: "", msg: "" });
            const [loading, setLoading] = React.useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setStatus({ type: "", msg: "" });
                setLoading(true);

                try {
                    if (isRegistering) {
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        const user = userCredential.user;
                        const libraryId = libraryName.toLowerCase().replace(/\s+/g, '-') + "-" + Date.now();

                        const batch = db.batch();
                        const userRef = db.collection("users").doc(user.uid);
                        const libRef = db.collection("libraries").doc(libraryId);

                        batch.set(userRef, { email: user.email, libraryId: libraryId, role: "manager" });
                        batch.set(libRef, { 
                            name: libraryName, 
                            ownerId: user.uid, 
                            totalSeats: Number(totalSeats),
                            priceSingle: Number(priceSingle),
                            priceBoth: Number(priceBoth),
                            monthlyRevenue: {}, 
                            createdAt: new Date().toISOString() 
                        });

                        await batch.commit();
                        await auth.signOut();
                        setIsRegistering(false);
                        setStatus({ type: "success", msg: "Registration successful! Please sign in to access your library." });
                        setEmail(""); setPassword("");
                    } else {
                        await auth.signInWithEmailAndPassword(email, password);
                    }
                } catch (err) {
                    setStatus({ type: "error", msg: err.message.replace("Firebase:", "").replace("auth/", "") });
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-gray-100">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4 text-2xl shadow-inner">
                                <i className="fa-solid fa-book-open"></i>
                            </div>
                            <h1 className="text-3xl font-bold text-gray-900 tracking-tight">LibManager Pro</h1>
                            <p className="text-gray-500 mt-2">{isRegistering ? "Setup your smart library" : "Manage your space efficiently"}</p>
                        </div>

                        {status.msg && (
                            <div className={`p-4 mb-6 rounded-xl text-sm font-medium ${status.type === 'success' ? 'bg-green-50 text-green-700 border border-green-200' : 'bg-red-50 text-red-700 border border-red-200'}`}>
                                {status.type === 'success' ? <i className="fa-solid fa-check-circle mr-2"></i> : <i className="fa-solid fa-exclamation-circle mr-2"></i>}
                                {status.msg}
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-5">
                            {isRegistering && (
                                <div className="animate-fade-in space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Library Name</label>
                                        <input type="text" required className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition" placeholder="e.g. City Central Library" value={libraryName} onChange={(e) => setLibraryName(e.target.value)} />
                                    </div>
                                    <div className="grid grid-cols-3 gap-3">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Seats</label>
                                            <input type="number" required className="w-full px-3 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-center" value={totalSeats} onChange={(e) => setTotalSeats(e.target.value)} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Fee (1)</label>
                                            <input type="number" required className="w-full px-3 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-center" value={priceSingle} onChange={(e) => setPriceSingle(e.target.value)} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Fee (2)</label>
                                            <input type="number" required className="w-full px-3 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-center" value={priceBoth} onChange={(e) => setPriceBoth(e.target.value)} />
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Email</label>
                                <input type="email" required className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition" placeholder="manager@example.com" value={email} onChange={(e) => setEmail(e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Password</label>
                                <input type="password" required className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition" placeholder="••••••••" value={password} onChange={(e) => setPassword(e.target.value)} />
                            </div>

                            <button type="submit" disabled={loading} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-200 transition-all duration-200 transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                                {loading ? <i className="fa-solid fa-circle-notch fa-spin"></i> : (isRegistering ? "Create Library Account" : "Sign In to Dashboard")}
                            </button>
                        </form>

                        <div className="mt-8 text-center">
                            <button onClick={() => { setIsRegistering(!isRegistering); setStatus({type:"", msg:""}); }} className="text-sm text-gray-500 hover:text-indigo-600 font-medium transition">
                                {isRegistering ? "Already have an account? Sign In" : "New here? Register a Library"}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const StatCard = ({ title, value, icon, color }) => (
            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                <div><p className="text-sm font-medium text-gray-500 mb-1">{title}</p><h3 className="text-2xl font-bold text-gray-800">{value}</h3></div>
                <div className={`w-12 h-12 rounded-full flex items-center justify-center text-xl ${color}`}><i className={icon}></i></div>
            </div>
        );

        const SeatModal = ({ seatId, seatNumber, slotData, defaultShift, onClose, onBook, onUpdate, onVacate, settings }) => {
            const [name, setName] = React.useState("");
            const [contact, setContact] = React.useState("");
            const [email, setEmail] = React.useState("");
            const [paymentMode, setPaymentMode] = React.useState("Cash");
            const [joinDate, setJoinDate] = React.useState(new Date().toISOString().split('T')[0]);
            const [selectedShift, setSelectedShift] = React.useState(defaultShift); 
            const [amount, setAmount] = React.useState(settings.priceSingle || 500);
            const [aiDraft, setAiDraft] = React.useState("");
            const [isDrafting, setIsDrafting] = React.useState(false);

            const isCurrentSlotOccupied = !!slotData;

            React.useEffect(() => {
                if (selectedShift === "both") setAmount(settings.priceBoth);
                else setAmount(settings.priceSingle);
            }, [selectedShift, settings]);

            const generateDraft = async () => {
                if (!isCurrentSlotOccupied) return;
                setIsDrafting(true);
                const prompt = `Write a polite WhatsApp message to ${slotData.studentName} reminding them that their library fee (₹${slotData.fee}) is due on ${slotData.feeDueDate}. Keep it short and professional.`;
                const response = await callGemini(prompt);
                if (response) setAiDraft(response);
                setIsDrafting(false);
            };

            const handlePrintReceipt = () => {
                const printWindow = window.open('', '_blank', 'height=600,width=800');
                if (!printWindow) {
                    alert("Pop-up blocked! Please allow pop-ups for this site to print receipts.");
                    return;
                }
                
                // Generate History Rows for Print
                const historyRows = (slotData.paymentHistory || []).map(p => 
                    `<tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 8px;">${p.date}</td>
                        <td style="padding: 8px;">${p.type}</td>
                        <td style="padding: 8px;">${p.mode}</td>
                        <td style="padding: 8px; text-align: right;">₹${p.amount}</td>
                     </tr>`
                ).join('');

                const historyTableHtml = (slotData.paymentHistory && slotData.paymentHistory.length > 0) ? `
                    <div style="margin-top: 30px;">
                        <h3 style="border-bottom: 1px solid #ccc; padding-bottom: 5px;">Payment History</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <tr style="background: #f9f9f9; text-align: left;">
                                <th style="padding: 8px;">Date</th>
                                <th style="padding: 8px;">Type</th>
                                <th style="padding: 8px;">Mode</th>
                                <th style="padding: 8px; text-align: right;">Amount</th>
                            </tr>
                            ${historyRows}
                        </table>
                    </div>
                ` : '';
                
                const html = `
                    <html>
                    <head>
                        <title>Receipt - Seat ${seatNumber}</title>
                        <style>
                            body { font-family: 'Helvetica', sans-serif; padding: 40px; color: #333; }
                            .header { text-align: center; margin-bottom: 40px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                            .details { margin-bottom: 20px; font-size: 15px; line-height: 1.6; }
                            .footer { text-align: center; margin-top: 50px; font-size: 12px; color: #666; border-top: 1px solid #eee; padding-top: 20px; }
                            .amount-box { background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534; padding: 15px; border-radius: 8px; text-align: center; margin: 20px 0; }
                            .amount-val { font-size: 24px; font-weight: bold; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>${settings.name || "Library Manager"}</h1>
                            <p>Official Fee Receipt</p>
                        </div>
                        <div class="details">
                            <table style="width: 100%;">
                                <tr><td><strong>Student Name:</strong></td><td>${slotData.studentName}</td></tr>
                                <tr><td><strong>Contact:</strong></td><td>${slotData.contact}</td></tr>
                                <tr><td><strong>Seat Number:</strong></td><td>${seatNumber} (${slotData.shift || defaultShift})</td></tr>
                                <tr><td><strong>Date:</strong></td><td>${new Date().toLocaleDateString()}</td></tr>
                                <tr><td><strong>Next Due Date:</strong></td><td>${slotData.feeDueDate}</td></tr>
                            </table>
                        </div>
                        
                        <div class="amount-box">
                            <div>Total Amount Paid</div>
                            <div class="amount-val">₹${slotData.fee}</div>
                        </div>

                        ${historyTableHtml}

                        <div class="footer">
                            <p>Thank you for your payment.</p>
                            <p>Generated by LibManager Pro</p>
                        </div>
                        <script>window.print();<\/script>
                    </body>
                    </html>
                `;
                
                printWindow.document.write(html);
                printWindow.document.close();
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in flex flex-col max-h-[90vh]">
                        <div className="bg-gray-50 px-8 py-5 border-b flex justify-between items-center shrink-0">
                            <div>
                                <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">Seat {seatNumber}</span>
                                <h3 className="text-xl font-bold text-gray-900 capitalize">
                                    {isCurrentSlotOccupied ? `${slotData.studentName}` : `Book ${defaultShift}`}
                                </h3>
                            </div>
                            <button onClick={onClose} className="w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:border-gray-400 transition">
                                <i className="fa-solid fa-times"></i>
                            </button>
                        </div>

                        <div className="p-8 overflow-y-auto custom-scrollbar">
                            {isCurrentSlotOccupied ? (
                                <div className="space-y-6">
                                    <div className="space-y-4">
                                        <div className="flex justify-between items-center py-2 border-b border-gray-100"><span className="text-sm text-gray-500">Contact</span><span className="font-medium text-gray-900">{slotData.contact}</span></div>
                                        <div className="flex justify-between items-center py-2 border-b border-gray-100"><span className="text-sm text-gray-500">Email</span><span className="font-medium text-gray-900">{slotData.email || 'N/A'}</span></div>
                                        <div className="flex justify-between items-center py-2 border-b border-gray-100"><span className="text-sm text-gray-500">Shift</span><span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 capitalize">{defaultShift}</span></div>
                                        <div className="flex justify-between items-center py-2 border-b border-gray-100"><span className="text-sm text-gray-500">Joined</span><span className="font-medium text-gray-900">{slotData.entryDate}</span></div>
                                        <div className="flex justify-between items-center py-2 border-b border-gray-100"><span className="text-sm text-gray-500">Next Fee Due</span><span className={`font-bold ${new Date(slotData.feeDueDate) < new Date() ? 'text-red-600' : 'text-green-600'}`}>{slotData.feeDueDate}</span></div>
                                        <div className="flex justify-between items-center py-2 border-b border-gray-100"><span className="text-sm text-gray-500">Fee Amount</span><span className="font-bold text-gray-700">₹{slotData.fee}</span></div>
                                        <div className="flex justify-between items-center py-2 border-b border-gray-100"><span className="text-sm text-gray-500">Payment Mode</span><span className="font-medium text-gray-700">{slotData.paymentMode || 'Cash'}</span></div>
                                    </div>

                                    {/* PAYMENT HISTORY TABLE */}
                                    {slotData.paymentHistory && slotData.paymentHistory.length > 0 && (
                                        <div className="mt-4">
                                            <h4 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Payment History</h4>
                                            <div className="bg-gray-50 rounded-lg border border-gray-200 overflow-hidden max-h-40 overflow-y-auto custom-scrollbar">
                                                <table className="w-full text-xs text-left">
                                                    <thead className="bg-gray-100 text-gray-500 border-b border-gray-200 sticky top-0">
                                                        <tr><th className="px-3 py-2 font-semibold">Date</th><th className="px-3 py-2 font-semibold">Type</th><th className="px-3 py-2 text-right font-semibold">Amount</th></tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-gray-200">
                                                        {slotData.paymentHistory.slice().reverse().map((p, i) => (
                                                            <tr key={i} className="hover:bg-gray-100">
                                                                <td className="px-3 py-2 text-gray-700">{p.date}</td>
                                                                <td className="px-3 py-2 text-gray-600">{p.type}</td>
                                                                <td className="px-3 py-2 text-right font-medium text-emerald-600">₹{p.amount}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    )}

                                    <button onClick={handlePrintReceipt} className="w-full border border-gray-300 text-gray-700 font-medium py-2 rounded-lg hover:bg-gray-50 transition flex items-center justify-center gap-2">
                                        <i className="fa-solid fa-print"></i> Print Fee Receipt
                                    </button>

                                    <div className="bg-gradient-to-br from-indigo-50 to-purple-50 p-4 rounded-xl border border-indigo-100">
                                        <div className="flex justify-between items-center mb-3">
                                            <span className="text-xs font-bold text-indigo-600 uppercase tracking-wide"><i className="fa-solid fa-sparkles mr-1"></i> AI Assistant</span>
                                            <button onClick={generateDraft} disabled={isDrafting} className="text-xs bg-white shadow-sm border border-indigo-100 text-indigo-600 px-3 py-1.5 rounded-lg hover:bg-indigo-50 transition">{isDrafting ? "Writing..." : "Draft Reminder"}</button>
                                        </div>
                                        {aiDraft ? (
                                            <div className="relative group">
                                                <textarea readOnly className="w-full text-sm text-gray-600 bg-white/50 p-3 rounded-lg border border-indigo-100 focus:outline-none h-24 resize-none" value={aiDraft}></textarea>
                                                <button onClick={() => {navigator.clipboard.writeText(aiDraft); alert("Copied!");}} className="absolute bottom-3 right-3 text-gray-400 hover:text-indigo-600 bg-white p-1.5 rounded shadow-sm opacity-0 group-hover:opacity-100 transition"><i className="fa-regular fa-copy"></i></button>
                                            </div>
                                        ) : (<p className="text-xs text-gray-400 italic">Generate a payment reminder message.</p>)}
                                    </div>

                                    <div className="grid grid-cols-2 gap-4 pt-2">
                                        <button onClick={() => onUpdate(seatId, defaultShift, slotData)} className="bg-green-600 text-white py-3 rounded-xl hover:bg-green-700 shadow-lg shadow-green-200 transition transform active:scale-95 flex items-center justify-center font-medium"><i className="fa-solid fa-check mr-2"></i>Mark Paid</button>
                                        <button onClick={() => onVacate(seatId, defaultShift, slotData)} className="bg-white text-red-500 border border-red-200 py-3 rounded-xl hover:bg-red-50 transition transform active:scale-95 flex items-center justify-center font-medium"><i className="fa-solid fa-user-minus mr-2"></i>Vacate</button>
                                    </div>
                                </div>
                            ) : (
                                <form onSubmit={(e) => { e.preventDefault(); onBook(seatId, name, contact, email, selectedShift, Number(amount), joinDate, paymentMode); }} className="space-y-5">
                                    <div><label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">Student Name <span className="text-red-500">*</span></label><input required type="text" className="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition" value={name} onChange={e => setName(e.target.value)} /></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">Phone <span className="text-red-500">*</span></label><input required type="tel" className="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition" value={contact} onChange={e => setContact(e.target.value)} /></div>
                                        <div><label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">Email <span className="text-red-500">*</span></label><input required type="email" className="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition" value={email} onChange={e => setEmail(e.target.value)} /></div>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">Joining Date</label>
                                        <input required type="date" className="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition" value={joinDate} onChange={e => setJoinDate(e.target.value)} />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">Shift</label>
                                            <select className="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" value={selectedShift} onChange={e => setSelectedShift(e.target.value)}>
                                                <option value={defaultShift}>{defaultShift === 'morning' ? 'Morning' : 'Evening'}</option>
                                                <option value="both">Both (Full Day)</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">Payment Mode</label>
                                            <select className="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" value={paymentMode} onChange={e => setPaymentMode(e.target.value)}>
                                                <option value="Cash">Cash</option>
                                                <option value="UPI">UPI (GPay/PhonePe)</option>
                                                <option value="Card">Card</option>
                                                <option value="NetBanking">Net Banking</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">Fee Amount (₹)</label>
                                        <input type="number" className="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition font-bold text-gray-700" value={amount} onChange={e => setAmount(e.target.value)} />
                                    </div>
                                    <button type="submit" className="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-200 mt-4 hover:bg-indigo-700 transition transform active:scale-95">Confirm Booking</button>
                                </form>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 3. ARCHIVES VIEW
        const ArchivesView = ({ libraryId }) => {
            const [archives, setArchives] = React.useState([]);
            const [searchTerm, setSearchTerm] = React.useState("");

            React.useEffect(() => {
                if (!libraryId) return;
                const unsubscribe = db.collection("libraries").doc(libraryId).collection("archives")
                    .orderBy("vacatedAt", "desc")
                    .onSnapshot(snapshot => {
                        const data = [];
                        snapshot.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
                        setArchives(data);
                    });
                return () => unsubscribe();
            }, [libraryId]);

            const filteredArchives = archives.filter(s => s.studentName.toLowerCase().includes(searchTerm.toLowerCase()));

            return (
                <div className="space-y-4">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-gray-800">Archived Students</h2>
                        <input type="text" placeholder="Search archives..." className="px-4 py-2 border rounded-lg text-sm w-64" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                    </div>
                    <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="bg-gray-50 text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-100">
                                    <tr>
                                        <th className="px-6 py-4">Name</th>
                                        <th className="px-6 py-4">Seat</th>
                                        <th className="px-6 py-4">Shift</th>
                                        <th className="px-6 py-4">Vacated Date</th>
                                        <th className="px-6 py-4">Total Paid</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-50">
                                    {filteredArchives.map(student => (
                                        <tr key={student.id} className="hover:bg-gray-50 transition">
                                            <td className="px-6 py-4 font-medium text-gray-900">{student.studentName}</td>
                                            <td className="px-6 py-4 text-gray-700">#{student.seatNumber}</td>
                                            <td className="px-6 py-4"><span className="px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600 capitalize">{student.shift}</span></td>
                                            <td className="px-6 py-4 text-sm text-gray-600">{new Date(student.vacatedAt.seconds * 1000).toLocaleDateString()}</td>
                                            <td className="px-6 py-4 font-bold text-gray-600">₹{(student.revenueCollected || 0).toLocaleString()}</td>
                                        </tr>
                                    ))}
                                    {filteredArchives.length === 0 && <tr><td colSpan="5" className="px-6 py-8 text-center text-gray-400 italic">No archives found.</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // 4. STUDENTS VIEW
        const StudentsView = ({ seats, searchQuery }) => {
            const allStudents = React.useMemo(() => {
                const list = [];
                Object.entries(seats).forEach(([seatId, data]) => {
                    const num = parseInt(seatId.split('-')[1]);
                    const m = data.morning;
                    const e = data.evening;
                    
                    // Check for Full Day (Same Contact in Morning and Evening for same seat)
                    if (m && e && m.contact === e.contact) {
                        list.push({ 
                            ...m, 
                            seatNo: num, 
                            slot: 'Full Day', 
                            id: `${num}_${m.contact}_full` 
                        });
                    } else {
                        if (m) list.push({ ...m, seatNo: num, slot: 'Morning', id: `${num}_${m.contact}_m` });
                        if (e) list.push({ ...e, seatNo: num, slot: 'Evening', id: `${num}_${e.contact}_e` });
                    }
                });
                return list.filter(s => s.studentName.toLowerCase().includes(searchQuery.toLowerCase()))
                           .sort((a, b) => a.seatNo - b.seatNo);
            }, [seats, searchQuery]);

            return (
                <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <div className="overflow-x-auto">
                        <table className="w-full text-left">
                            <thead className="bg-gray-50 text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-100">
                                <tr>
                                    <th className="px-6 py-4">Seat</th>
                                    <th className="px-6 py-4">Name</th>
                                    <th className="px-6 py-4">Email / Phone</th>
                                    <th className="px-6 py-4">Shift</th>
                                    <th className="px-6 py-4">Joined</th>
                                    <th className="px-6 py-4">Next Fees Date</th>
                                    <th className="px-6 py-4 text-right">Lifetime Paid</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-50">
                                {allStudents.map(student => (
                                    <tr key={student.id} className="hover:bg-gray-50 transition">
                                        <td className="px-6 py-4 font-bold text-gray-700">#{student.seatNo}</td>
                                        <td className="px-6 py-4 font-medium text-gray-900">{student.studentName}</td>
                                        <td className="px-6 py-4 text-sm text-gray-600">
                                            <div className="font-medium">{student.contact}</div>
                                            <div className="text-xs text-gray-400">{student.email}</div>
                                        </td>
                                        <td className="px-6 py-4"><span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${student.slot === 'Morning' ? 'bg-orange-100 text-orange-800' : student.slot === 'Evening' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'}`}>{student.slot}</span></td>
                                        <td className="px-6 py-4 text-sm text-gray-600">{student.entryDate}</td>
                                        <td className="px-6 py-4 text-sm font-medium text-indigo-600">{student.feeDueDate}</td>
                                        <td className="px-6 py-4 text-right font-bold text-emerald-600">₹{(student.revenueCollected || 0).toLocaleString()}</td>
                                    </tr>
                                ))}
                                {allStudents.length === 0 && <tr><td colSpan="7" className="px-6 py-8 text-center text-gray-400 italic">No students found.</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // 5. FINANCES VIEW (Updated with Monthly Chart)
        const FinancesView = ({ seatRevenues, totalSeats, monthlyRevenue }) => {
            const revenueList = React.useMemo(() => {
                return Array.from({ length: totalSeats }, (_, i) => i + 1).map(num => ({
                    seatNo: num,
                    total: seatRevenues?.[num.toString()] || 0
                })).sort((a, b) => b.total - a.total); 
            }, [seatRevenues, totalSeats]);

            // Analytics Calculations
            const analytics = React.useMemo(() => {
                const months = Object.keys(monthlyRevenue || {}).sort();
                const values = months.map(m => monthlyRevenue[m]);
                const maxVal = values.length ? Math.max(...values) : 1;
                
                // Current vs Previous Month logic
                const date = new Date();
                const currentKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                // Previous month calculation
                date.setMonth(date.getMonth() - 1);
                const prevKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

                const currentVal = monthlyRevenue[currentKey] || 0;
                const prevVal = monthlyRevenue[prevKey] || 0;
                
                let percentChange = 0;
                if (prevVal > 0) {
                    percentChange = ((currentVal - prevVal) / prevVal) * 100;
                } else if (currentVal > 0) {
                    percentChange = 100; // 100% growth from 0
                }

                const totalLifetime = values.reduce((a, b) => a + b, 0);
                const average = values.length ? Math.round(totalLifetime / values.length) : 0;

                return { months, maxVal, currentVal, prevVal, percentChange, totalLifetime, average };
            }, [monthlyRevenue]);

            return (
                <div className="space-y-6">
                    {/* 1. KPIs */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                            <p className="text-sm font-medium text-gray-500 mb-1">This Month</p>
                            <h3 className="text-3xl font-bold text-gray-900">₹{analytics.currentVal.toLocaleString()}</h3>
                            <div className={`mt-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${analytics.percentChange >= 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                <i className={`fa-solid fa-arrow-${analytics.percentChange >= 0 ? 'up' : 'down'} mr-1`}></i>
                                {Math.abs(analytics.percentChange).toFixed(1)}% vs last month
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                            <p className="text-sm font-medium text-gray-500 mb-1">Last Month</p>
                            <h3 className="text-3xl font-bold text-gray-900 opacity-60">₹{analytics.prevVal.toLocaleString()}</h3>
                            <p className="text-xs text-gray-400 mt-2">Target: ₹{(analytics.average * 1.1).toLocaleString()}</p>
                        </div>
                        <div className="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-2xl p-6 text-white shadow-xl">
                            <p className="text-indigo-100 text-sm font-medium mb-1">Total Lifetime Revenue</p>
                            <h3 className="text-3xl font-bold">₹{analytics.totalLifetime.toLocaleString()}</h3>
                            <p className="text-xs text-indigo-200 mt-2">Average: ₹{analytics.average.toLocaleString()}/mo</p>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        {/* 2. Main Trend Chart */}
                        <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-200 lg:col-span-2">
                            <div className="flex justify-between items-end mb-8">
                                <div>
                                    <h3 className="text-lg font-bold text-gray-800">Revenue Trend</h3>
                                    <p className="text-sm text-gray-500">Monthly income performance</p>
                                </div>
                            </div>
                            <div className="h-64 w-full flex items-end gap-3 overflow-x-auto custom-scrollbar pb-2">
                                {analytics.months.length === 0 && <div className="w-full text-center text-gray-400 italic self-center">No revenue data yet.</div>}
                                {analytics.months.map(month => {
                                    const val = monthlyRevenue[month];
                                    const heightPercent = (val / analytics.maxVal) * 100;
                                    const isCurrent = month === `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}`;
                                    
                                    return (
                                        <div key={month} className="flex flex-col items-center gap-2 group min-w-[60px] flex-1">
                                            <div className="w-full relative h-48 flex items-end justify-center">
                                                <div 
                                                    style={{ height: `${Math.max(heightPercent, 2)}%` }} 
                                                    className={`w-full max-w-[40px] rounded-t-md transition-all relative group-hover:opacity-90 ${isCurrent ? 'bg-indigo-600' : 'bg-indigo-300'}`}
                                                >
                                                    <span className="absolute -top-8 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">₹{val.toLocaleString()}</span>
                                                </div>
                                            </div>
                                            <span className={`text-[10px] font-bold ${isCurrent ? 'text-indigo-600' : 'text-gray-400'}`}>{month}</span>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>

                        {/* 3. Top Seats List */}
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 flex flex-col h-[400px]">
                            <h3 className="text-lg font-bold text-gray-800 mb-4">Top Performing Seats</h3>
                            <div className="flex-1 overflow-y-auto custom-scrollbar pr-2 space-y-3">
                                {revenueList.slice(0, 10).map((item, index) => (
                                    <div key={item.seatNo} className="flex items-center justify-between p-3 rounded-lg bg-gray-50 border border-gray-100">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${index < 3 ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-200 text-gray-600'}`}>#{index + 1}</div>
                                            <div>
                                                <p className="text-xs font-bold text-gray-700">Seat {item.seatNo}</p>
                                                <p className="text-[10px] text-gray-400">Rank {index + 1}</p>
                                            </div>
                                        </div>
                                        <span className="text-sm font-bold text-gray-900">₹{item.total.toLocaleString()}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 7. ASK AI COMPONENT
        const AskAIComponent = () => {
            const [query, setQuery] = React.useState("");
            const [answer, setAnswer] = React.useState("");
            const [loading, setLoading] = React.useState(false);

            const handleAsk = async () => {
                if(!query) return;
                setLoading(true);
                const resp = await callGemini(query);
                setAnswer(resp);
                setLoading(false);
            };

            return (
                <div className="bg-gradient-to-r from-violet-50 to-indigo-50 p-6 rounded-2xl border border-indigo-100 mt-8">
                    <div className="flex items-center gap-3 mb-4">
                        <div className="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-xl shadow-sm text-indigo-600">
                            <i className="fa-solid fa-robot"></i>
                        </div>
                        <h3 className="text-lg font-bold text-gray-800">Ask AI Assistant</h3>
                    </div>
                    <div className="bg-white p-2 rounded-xl border border-indigo-100 shadow-sm flex gap-2">
                        <input type="text" className="flex-1 px-4 py-2 outline-none text-sm" placeholder="Ask a question (e.g., 'How to improve student retention?')" value={query} onChange={e => setQuery(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleAsk()} />
                        <button onClick={handleAsk} disabled={loading} className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition">
                            {loading ? <i className="fa-solid fa-spinner fa-spin"></i> : <i className="fa-solid fa-paper-plane"></i>}
                        </button>
                    </div>
                    {answer && (
                        <div className="mt-4 bg-white p-4 rounded-xl border border-indigo-50 text-sm text-gray-700 leading-relaxed animate-fade-in shadow-sm">
                            <span className="font-bold text-indigo-600">AI:</span> {answer}
                        </div>
                    )}
                </div>
            );
        };

        // 8. MAIN APP
        const MainApp = () => {
            const [user, setUser] = React.useState(null);
            const [libraryId, setLibraryId] = React.useState(null);
            const [librarySettings, setLibrarySettings] = React.useState({ totalSeats: 150, priceSingle: 500, priceBoth: 900, seatRevenues: {}, monthlyRevenue: {} });
            const [seats, setSeats] = React.useState({});
            const [loading, setLoading] = React.useState(true);
            const [selectedSeat, setSelectedSeat] = React.useState(null);
            const [searchQuery, setSearchQuery] = React.useState("");
            const [currentView, setCurrentView] = React.useState("dashboard"); // dashboard, students, finances, archives, settings
            const [aiInsight, setAiInsight] = React.useState(null);
            const [isAnalyzing, setIsAnalyzing] = React.useState(false);

            // Listeners
            React.useEffect(() => {
                if (!auth) { setLoading(false); return; }
                return auth.onAuthStateChanged((u) => {
                    setUser(u);
                    if (!u) { setLibraryId(null); setSeats({}); setLoading(false); }
                });
            }, []);

            React.useEffect(() => {
                if (!user) return;
                return db.collection("users").doc(user.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        const libId = doc.data().libraryId;
                        setLibraryId(libId);
                        db.collection("libraries").doc(libId).onSnapshot(libDoc => {
                            if (libDoc.exists) setLibrarySettings(libDoc.data());
                        });
                        setLoading(false);
                    }
                });
            }, [user]);

            React.useEffect(() => {
                if (!libraryId) return;
                return db.collection("libraries").doc(libraryId).collection("seats").onSnapshot(snapshot => {
                    const seatMap = {};
                    snapshot.forEach(doc => seatMap[doc.id] = doc.data());
                    setSeats(seatMap);
                });
            }, [libraryId]);

            // Helper to get Month Key
            const getCurrentMonthKey = () => {
                const d = new Date();
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            };

            // Database Logic
            const handleBookSeat = async (seatId, name, contact, email, shift, fee, joinDate, paymentMode) => {
                if (!libraryId) return;
                const entry = new Date(joinDate);
                const due = new Date(joinDate);
                due.setMonth(due.getMonth() + 1);
                
                const studentData = {
                    studentName: name,
                    contact: contact,
                    email: email, 
                    paymentMode: paymentMode, 
                    fee: Number(fee), 
                    revenueCollected: Number(fee),
                    entryDate: entry.toISOString().split('T')[0],
                    feeDueDate: due.toISOString().split('T')[0],
                    paymentHistory: [{
                        date: new Date().toISOString().split('T')[0],
                        amount: Number(fee),
                        mode: paymentMode,
                        type: 'Joining Fee'
                    }]
                };

                const updatePayload = {};
                if (shift === "both") { updatePayload.morning = studentData; updatePayload.evening = studentData; }
                else { updatePayload[shift] = studentData; }

                const batch = db.batch();
                batch.set(db.collection("libraries").doc(libraryId).collection("seats").doc(seatId), updatePayload, { merge: true });
                
                const seatNum = seatId.split('-')[1];
                const revenueKey = `seatRevenues.${seatNum}`;
                const monthKey = `monthlyRevenue.${getCurrentMonthKey()}`; // Monthly tracking

                batch.update(db.collection("libraries").doc(libraryId), {
                    lifetimeRevenue: firebase.firestore.FieldValue.increment(Number(fee)),
                    [revenueKey]: firebase.firestore.FieldValue.increment(Number(fee)),
                    [monthKey]: firebase.firestore.FieldValue.increment(Number(fee))
                });

                await batch.commit();
                setSelectedSeat(null);
            };

            const handleUpdateFee = async (seatId, shift, currentData) => {
                if (!libraryId) return;
                const newDate = new Date(currentData.feeDueDate);
                newDate.setMonth(newDate.getMonth() + 1);
                
                const updatePathDate = `${shift}.feeDueDate`;
                const updatePathRev = `${shift}.revenueCollected`;
                const updatePathHist = `${shift}.paymentHistory`;
                
                const newHistoryItem = {
                    date: new Date().toISOString().split('T')[0],
                    amount: currentData.fee,
                    mode: 'Renewal', 
                    type: 'Monthly Fee'
                };
                
                const currentHistory = currentData.paymentHistory || [];
                const updatedHistory = [...currentHistory, newHistoryItem];

                const batch = db.batch();
                batch.update(db.collection("libraries").doc(libraryId).collection("seats").doc(seatId), {
                    [updatePathDate]: newDate.toISOString().split('T')[0],
                    [updatePathRev]: firebase.firestore.FieldValue.increment(currentData.fee),
                    [updatePathHist]: updatedHistory
                });
                
                const seatNum = seatId.split('-')[1];
                const revenueKey = `seatRevenues.${seatNum}`;
                const monthKey = `monthlyRevenue.${getCurrentMonthKey()}`;

                batch.update(db.collection("libraries").doc(libraryId), {
                    lifetimeRevenue: firebase.firestore.FieldValue.increment(currentData.fee),
                    [revenueKey]: firebase.firestore.FieldValue.increment(currentData.fee),
                    [monthKey]: firebase.firestore.FieldValue.increment(currentData.fee)
                });

                await batch.commit();
                setSelectedSeat(null);
            };

            const handleVacate = async (seatId, shift, currentData) => {
                if (!libraryId) return;
                
                const batch = db.batch();
                const archivesRef = db.collection("libraries").doc(libraryId).collection("archives");
                const seatRef = db.collection("libraries").doc(libraryId).collection("seats").doc(seatId);

                // 1. Archive & Delete Current Slot
                batch.set(archivesRef.doc(), {
                    ...currentData,
                    seatNumber: seatId.split('-')[1],
                    shift: shift,
                    vacatedAt: new Date()
                });
                const updatePayload = { [shift]: firebase.firestore.FieldValue.delete() };

                // 2. Check for "Full Day" / Same Student in other shift (Using Contact as Primary Key)
                const seatDoc = seats[seatId];
                const otherShift = shift === 'morning' ? 'evening' : 'morning';
                const otherSlotData = seatDoc ? seatDoc[otherShift] : null;

                // Check if other slot exists AND contact matches (Primary Key)
                if (otherSlotData && otherSlotData.contact === currentData.contact) {
                    // Archive Other Slot
                    batch.set(archivesRef.doc(), {
                        ...otherSlotData,
                        seatNumber: seatId.split('-')[1],
                        shift: otherShift,
                        vacatedAt: new Date()
                    });
                    // Delete Other Slot
                    updatePayload[otherShift] = firebase.firestore.FieldValue.delete();
                }
                
                batch.update(seatRef, updatePayload);
                
                await batch.commit();
                setSelectedSeat(null);
            };

            // Stats
            const stats = React.useMemo(() => {
                let dueList = [], overdueList = [];
                const today = new Date();
                let occupiedCount = 0;

                const processEntry = (slot, seatNum, shiftLabel) => {
                    const d = new Date(slot.feeDueDate);
                    const diff = Math.ceil((d - today) / (1000 * 60 * 60 * 24));
                    const entry = { ...slot, seatNo: seatNum, shift: shiftLabel, id: `${seatNum}_${slot.studentName}` };
                    if (diff < 0) overdueList.push(entry);
                    else if (diff <= 3) dueList.push(entry);
                };

                Object.entries(seats).forEach(([id, data]) => {
                    const num = id.split('-')[1];
                    const m = data.morning;
                    const e = data.evening;

                    if (m && e && m.contact === e.contact) {
                        // Full Day - Process once to remove duplicates in lists
                        processEntry(m, num, 'Full Day');
                    } else {
                        if (m) processEntry(m, num, 'Morning');
                        if (e) processEntry(e, num, 'Evening');
                    }
                });

                const totalPhysical = librarySettings.totalSeats || 150;
                const physicalOccupied = Object.values(seats).filter(s => s.morning || s.evening).length;
                const percent = Math.round((physicalOccupied / totalPhysical) * 100);
                
                const currentMonthRevenue = librarySettings.monthlyRevenue?.[getCurrentMonthKey()] || 0;

                return { 
                    revenue: currentMonthRevenue, // CHANGED TO MONTHLY
                    percent, dueList, overdueList 
                };
            }, [seats, librarySettings]);

            // Slot Button
            const SlotButton = ({ shift, data, onClick, isSearchMatch }) => {
                let bgClass = "bg-white text-gray-300 hover:bg-gray-50";
                let icon = shift === "morning" ? "fa-sun" : "fa-moon";
                let iconColor = "text-gray-200";
                
                if (data) {
                    const today = new Date();
                    const due = new Date(data.feeDueDate);
                    const diff = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
                    
                    if (diff < 0) { // Overdue
                        bgClass = "bg-rose-50 text-rose-600 border-l-2 border-rose-500";
                        iconColor = "text-rose-400";
                    } else if (diff <= 3) { // Due Soon
                        bgClass = "bg-amber-50 text-amber-600 border-l-2 border-amber-500";
                        iconColor = "text-amber-400";
                    } else { // Normal
                        bgClass = shift === 'morning' ? "bg-orange-50 text-orange-600 border-l-2 border-orange-400" : "bg-blue-50 text-blue-600 border-l-2 border-blue-400";
                        iconColor = shift === 'morning' ? "text-orange-300" : "text-blue-300";
                    }
                }

                if (isSearchMatch) bgClass = "bg-pink-100 text-pink-600 border-pink-500 ring-2 ring-pink-300 z-10";

                return (
                    <button onClick={(e) => { e.stopPropagation(); onClick(); }} className={`w-full flex-1 flex items-center justify-between px-2 transition-colors ${bgClass}`}>
                        <div className="flex items-center gap-1.5 overflow-hidden">
                            <i className={`fa-solid ${icon} text-[10px] ${iconColor}`}></i>
                            <span className="text-[9px] font-bold truncate">{data ? data.studentName.split(' ')[0] : 'Empty'}</span>
                        </div>
                        {data && (new Date(data.feeDueDate) < new Date()) && <span className="w-1.5 h-1.5 rounded-full bg-rose-500"></span>}
                    </button>
                );
            };

            const generateInsights = async () => {
                setIsAnalyzing(true);
                const prompt = `Analyze: This Month Revenue ₹${stats.revenue}, Occupancy ${stats.percent}%, Overdue ${stats.overdueList.length}, Due Soon ${stats.dueList.length}. Give 1 short business tip.`;
                const response = await callGemini(prompt);
                setAiInsight(response); setIsAnalyzing(false);
            };

            if (loading) return <div className="h-screen flex items-center justify-center bg-gray-50"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div></div>;
            if (!user) return <AuthScreen />;

            return (
                <div className="flex h-screen overflow-hidden bg-gray-50">
                    {/* SIDEBAR */}
                    <div className="w-72 bg-white sidebar-glass border-r border-gray-200 hidden md:flex flex-col z-20 shadow-xl">
                        <div className="p-8">
                            <div className="flex items-center gap-3 text-indigo-600 mb-10">
                                <div className="w-10 h-10 bg-indigo-600 text-white rounded-xl flex items-center justify-center text-xl shadow-lg shadow-indigo-200"><i className="fa-solid fa-book-open"></i></div>
                                <span className="text-2xl font-bold tracking-tight text-gray-900">LibPro</span>
                            </div>
                            <div className="space-y-2">
                                <button onClick={() => setCurrentView('dashboard')} className={`w-full flex items-center px-4 py-3.5 rounded-xl font-semibold transition-all ${currentView === 'dashboard' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'text-gray-500 hover:bg-gray-50'}`}><i className="fa-solid fa-grid-2 w-8"></i> Dashboard</button>
                                <button onClick={() => setCurrentView('students')} className={`w-full flex items-center px-4 py-3.5 rounded-xl font-semibold transition-all ${currentView === 'students' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'text-gray-500 hover:bg-gray-50'}`}><i className="fa-solid fa-users w-8"></i> Students</button>
                                <button onClick={() => setCurrentView('archives')} className={`w-full flex items-center px-4 py-3.5 rounded-xl font-semibold transition-all ${currentView === 'archives' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'text-gray-500 hover:bg-gray-50'}`}><i className="fa-solid fa-box-archive w-8"></i> Archives</button>
                                <button onClick={() => setCurrentView('finances')} className={`w-full flex items-center px-4 py-3.5 rounded-xl font-semibold transition-all ${currentView === 'finances' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'text-gray-500 hover:bg-gray-50'}`}><i className="fa-solid fa-chart-line w-8"></i> Finances</button>
                            </div>
                        </div>
                        <div className="mt-auto p-8 border-t border-gray-100">
                            <button onClick={() => auth.signOut()} className="flex items-center text-red-500 hover:bg-red-50 w-full px-4 py-3 rounded-xl transition font-medium"><i className="fa-solid fa-sign-out-alt w-6"></i> Logout</button>
                        </div>
                    </div>

                    {/* MAIN */}
                    <div className="flex-1 flex flex-col h-screen overflow-hidden relative">
                        <header className="bg-white/80 backdrop-blur-md border-b border-gray-200 px-8 py-5 flex justify-between items-center z-10 sticky top-0">
                            <div><h2 className="text-xl font-bold text-gray-900 capitalize">{currentView}</h2><p className="text-sm text-gray-500">{librarySettings.name}</p></div>
                            {currentView !== 'finances' && currentView !== 'settings' && (
                                <div className="bg-white border rounded-full px-4 py-2.5 flex items-center gap-3 shadow-sm w-72 focus-within:ring-2 ring-indigo-100 transition">
                                    <i className="fa-solid fa-search text-gray-400"></i>
                                    <input type="text" placeholder="Search..." className="bg-transparent outline-none text-sm w-full" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                                </div>
                            )}
                        </header>

                        <main className="flex-1 overflow-auto p-8 custom-scrollbar">
                            {currentView === 'dashboard' && (
                                <>
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between"><div className="text-emerald-600"><p className="text-sm font-medium mb-1 opacity-80">This Month Revenue</p><h3 className="text-2xl font-bold">₹{stats.revenue.toLocaleString()}</h3></div><div className="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-xl flex items-center justify-center text-xl"><i className="fa-solid fa-calendar-days"></i></div></div>
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between"><div className="text-blue-600"><p className="text-sm font-medium mb-1 opacity-80">Occupancy</p><h3 className="text-2xl font-bold">{stats.percent}%</h3></div><div className="w-12 h-12 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center text-xl"><i className="fa-solid fa-chart-pie"></i></div></div>
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between"><div className="text-amber-600"><p className="text-sm font-medium mb-1 opacity-80">Fees Due Soon</p><h3 className="text-2xl font-bold">{stats.dueList.length}</h3></div><div className="w-12 h-12 bg-amber-100 text-amber-600 rounded-xl flex items-center justify-center text-xl"><i className="fa-solid fa-clock"></i></div></div>
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between"><div className="text-rose-600"><p className="text-sm font-medium mb-1 opacity-80">Overdue</p><h3 className="text-2xl font-bold">{stats.overdueList.length}</h3></div><div className="w-12 h-12 bg-rose-100 text-rose-600 rounded-xl flex items-center justify-center text-xl"><i className="fa-solid fa-triangle-exclamation"></i></div></div>
                                    </div>

                                    {/* AI Section (Moved Below Stats) */}
                                    <div className="mb-8 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                        <div className="flex items-center justify-between mb-4">
                                            <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2"><i className="fa-solid fa-wand-magic-sparkles text-indigo-500"></i> AI Insights</h3>
                                            <button onClick={generateInsights} disabled={isAnalyzing} className="ai-btn text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:shadow-lg transition transform active:scale-95">{isAnalyzing ? "Analyzing..." : "Analyze Business"}</button>
                                        </div>
                                        {aiInsight && <div className="bg-indigo-50 p-4 rounded-xl text-sm text-indigo-900 border border-indigo-100 animate-fade-in">{aiInsight}</div>}
                                    </div>

                                    {/* Seat Grid - DUAL SHIFT DISPLAY */}
                                    <div className="bg-white p-8 rounded-3xl shadow-sm border border-gray-200 mb-8">
                                        <div className="flex justify-between items-center mb-6">
                                            <h3 className="text-lg font-bold text-gray-800">Seat Grid</h3>
                                            <div className="text-xs text-gray-400 font-medium">Click top/bottom of slot</div>
                                        </div>
                                        <div className="seat-grid">
                                            {Array.from({ length: librarySettings.totalSeats || 150 }, (_, i) => i + 1).map(num => {
                                                const seatId = `seat-${num}`;
                                                const data = seats[seatId] || {};
                                                
                                                const isMorningMatch = searchQuery && data.morning && data.morning.studentName.toLowerCase().includes(searchQuery.toLowerCase());
                                                const isEveningMatch = searchQuery && data.evening && data.evening.studentName.toLowerCase().includes(searchQuery.toLowerCase());

                                                return (
                                                    <div key={num} className="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm flex flex-col h-24 hover:shadow-md transition-shadow">
                                                        <div className="bg-gray-50 px-2 py-1 text-[10px] font-bold text-center border-b border-gray-100 text-gray-500">Seat {num}</div>
                                                        <div className="flex-1 flex flex-col">
                                                            <SlotButton shift="morning" data={data.morning} isSearchMatch={isMorningMatch} onClick={() => setSelectedSeat({ id: seatId, number: num, data: data.morning, defaultShift: 'morning' })} />
                                                            <div className="h-px bg-gray-100"></div>
                                                            <SlotButton shift="evening" data={data.evening} isSearchMatch={isEveningMatch} onClick={() => setSelectedSeat({ id: seatId, number: num, data: data.evening, defaultShift: 'evening' })} />
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>

                                    {/* Action Lists (Moved Below Grid) */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 h-64 overflow-y-auto custom-scrollbar">
                                            <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4 flex items-center"><i className="fa-solid fa-circle text-rose-500 text-[8px] mr-2"></i> Overdue Payments</h3>
                                            {stats.overdueList.length === 0 ? <p className="text-gray-400 text-sm italic">No overdue payments.</p> : (
                                                <div className="space-y-3">
                                                    {stats.overdueList.map((s, i) => (
                                                        <div key={i} className="flex justify-between items-center p-3 bg-rose-50 rounded-lg border border-rose-100">
                                                            <div><p className="font-bold text-gray-800 text-sm">{s.studentName}</p><p className="text-xs text-rose-600">Seat {s.seatNo} ({s.shift})</p></div>
                                                            <div className="text-right"><p className="font-bold text-rose-700 text-sm">Due: {s.feeDueDate}</p></div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 h-64 overflow-y-auto custom-scrollbar">
                                            <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4 flex items-center"><i className="fa-solid fa-circle text-amber-400 text-[8px] mr-2"></i> Due Soon (3 Days)</h3>
                                            {stats.dueList.length === 0 ? <p className="text-gray-400 text-sm italic">No upcoming payments.</p> : (
                                                <div className="space-y-3">
                                                    {stats.dueList.map((s, i) => (
                                                        <div key={i} className="flex justify-between items-center p-3 bg-amber-50 rounded-lg border border-amber-100">
                                                            <div><p className="font-bold text-gray-800 text-sm">{s.studentName}</p><p className="text-xs text-amber-600">Seat {s.seatNo} ({s.shift})</p></div>
                                                            <div className="text-right"><p className="font-bold text-amber-700 text-sm">Due: {s.feeDueDate}</p></div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {/* ASK AI (At Bottom) */}
                                    <AskAIComponent />
                                </>
                            )}

                            {currentView === 'students' && <StudentsView seats={seats} searchQuery={searchQuery} />}
                            {currentView === 'archives' && <ArchivesView libraryId={libraryId} />}
                            {currentView === 'finances' && <FinancesView seatRevenues={librarySettings.seatRevenues} totalSeats={librarySettings.totalSeats || 150} monthlyRevenue={librarySettings.monthlyRevenue || {}} />}
                        </main>
                    </div>

                    {selectedSeat && <SeatModal seatId={selectedSeat.id} seatNumber={selectedSeat.number} slotData={selectedSeat.data} defaultShift={selectedSeat.defaultShift} onClose={() => setSelectedSeat(null)} onBook={handleBookSeat} onUpdate={handleUpdateFee} onVacate={handleVacate} settings={librarySettings} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MainApp />);
    </script>
</body>
</html>
```
